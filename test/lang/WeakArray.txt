namespace lang;

public class WeakArray<T> : List<T> {

    private final int length;
    public int Length {
        get {
            return length;
        }
    }

    public let T this[int i] {
        get, own {
            native (return) {
                return data[ ARRAY_ACESS(v_i, f_length) ];
            }
        }
        set {
            native (source) {
                data[ ARRAY_ACESS(v_i, f_length) ] = v_value;
            }
        }
    }

    native (header) {
        GLet<g_T>* data;
        lang_WeakArray<g_T>* create(GLet<g_T>* list, long size);
    }

    native (source) {
        template <typename g_T>
        lang_WeakArray<g_T>* lang_WeakArray<g_T>::create(GLet<g_T>* list, long size) {
            this->data = sCast(GLet<g_T>*, lang::memory::array(sizeof(GLet<g_T>), size));

            if (this->data == nullptr) {
                this->f_length = 0;
            } else {
                this->f_length = size;
                for (long i = 0; i < size; i++) {
                    this->data[i] = list[i];
                }
            }
            return this;
        }
    }

    public this() {
        this.length = 0;

        native (source) {
            this->data = nullptr;
        }
    }

    public this(int length) {
        native (source) {
            this->data = sCast(GLet<g_T>*, lang::memory::array(sizeof(GLet<g_T>), v_length));

            if (this->data == nullptr) {
                this->f_length = 0;
            } else {
                this->f_length = v_length;
                for (long i = 0; i < v_length; i++) {
                    this->data[i] = lang::value<GLet<g_T>>::def();
                }
            }
        }
    }
}